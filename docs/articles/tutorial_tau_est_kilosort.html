<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Network time constants from KiloSort4 data • neurons</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Network time constants from KiloSort4 data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">neurons</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Introduction</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Package Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Installation</h6></li>
    <li><a class="dropdown-item" href="../articles/install.html">Installation instructions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/tutorial_synchrony_crosscorr.html">Spike synchrony via cross-correlation</a></li>
    <li><a class="dropdown-item" href="../articles/tutorial_tau_est_DG.html">Network time constants via dichotomized Gaussians</a></li>
    <li><a class="dropdown-item" href="../articles/tutorial_tau_est_kilosort.html">Network time constants from KiloSort4 data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Legal</h6></li>
    <li><a class="dropdown-item" href="../articles/license.html">Dependency licenses</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/michaelbarkasi/neurons"><span class="fa fab fa-github"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../#">🌙</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Network time constants from KiloSort4 data</h1>
            
      

      <div class="d-none name"><code>tutorial_tau_est_kilosort.Rmd</code></div>
    </div>

    
    
<p>The neurons package provides functions to use <a href="tutorial_tau_est_DG.html">dichotomized Gaussians to estimate
network time constants</a> on different kinds of spike data (<a href="https://doi.org/10.1162/neco.2008.02-08-713" class="external-link">Macke et
al. 2009</a>, <a href="https://doi.org/10.1371/journal.pbio.3001803" class="external-link">Neophytou et
al. 2022</a>), including kilosort4 output. <a href="https://doi.org/10.1038/s41592-024-02232-7" class="external-link">KiloSort4</a> is a <a href="https://github.com/MouseLand/Kilosort" class="external-link">Python package</a> for
extracting spike clusters (a proxy for individual neurons) from
multi-channel probe recordings. Network time constants provide an
estimate of recurrence by quantifying decay in spiking autocorrelation
as a function of lag time. A higher network time constant indicates that
a neuron receives a larger number of projections back on itself.
Intuitively, the longer into the future a spike <em>now</em> increases
the probability of a spike <em>later</em>, the stronger the connections
from that neuron back onto itself must be.</p>
<h2>
Load data
</h2>
<p>Begin by clearing the R workspace, setting a random-number generator
seed, and loading the neurons package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clear the R workspace to start fresh</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Load neurons package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">)</span> </span></code></pre></div>
<h3>
Spike and stimulus data
</h3>
<p>Provide the file path to the output from kilosort4. Recordings from
the left and right hemisphere of various genotypes of mice are used for
this tutortial. These recordings targeted the auditory cortex and were
made while auditory stimuli were played at regular intervals.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set path to data </span></span>
<span><span class="va">demo_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span></span>
<span>    <span class="st">"extdata"</span>, </span>
<span>    <span class="st">"kilo4demo"</span>, </span>
<span>    package <span class="op">=</span> <span class="st">"neurons"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The function used to process kilosort4 output is <a href="../reference/preprocess.kilo4.html">preprocess.kilo4</a>. This
function expects its argument <strong>data_path</strong> to point to a
folder the subfolders of which each contain a single kilosort4 output.
This output should be in its own folder <strong>/kilosort4</strong>. The
following four files are needed:</p>
<ul>
<li>
<strong>spike_positions.npy</strong>: 2D array giving the x and y
position of each spike<br>
</li>
<li>
<strong>spike_clusters.npy</strong>: integer giving the cluster
number of each spike<br>
</li>
<li>
<strong>spike_times.npy</strong>: sample number at which the spike
occurred</li>
<li>
<strong>cluster_group.tsv</strong> or
<strong>cluster_KSLabel.tsv</strong> or
<strong>cluster_info.tsv</strong>: 2D array giving status of each
cluster (0=noise, 1=MUA, 2=Good, 3=unsorted)</li>
</ul>
<p>In addition, a MATLAB file <strong>includeVector.mat</strong>
specifying whether each cluster is stimulus-responisve (1) or not (0)
should be included in the kilosort4 folder. Finally, along with the
kilosort4 subfolder, there should be a file
<strong>StimulusStamps.csv</strong> in each recording folder.</p>
<div class="figure">
<img src="fig_folderstructure.png" alt="Image showing folder structure necessary for preprocess.kilo4 function." width="90%"><p class="caption">
Folder structure necessary for <a href="../reference/preprocess.kilo4.html">preprocess.kilo4</a> function.
</p>
</div>
<h3>
Covariate data
</h3>
<p>Metadata about the recordings (formatted as a dataframe) is needed to
supply covariates.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load </span></span>
<span><span class="va">kilo4_metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span></span>
<span>      <span class="st">"extdata"</span>, </span>
<span>      <span class="st">"meta_data_kilo4demo.csv"</span>, </span>
<span>      package <span class="op">=</span> <span class="st">"neurons"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">kilo4_metadata</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          DAY Neuralynx_ID   EXPER HEMISPHERE PROBE COORDINATES_SHANK_1 COORDINATES_SHANK_2    STRAIN AGE SEX  DEPTH</span></span>
<span><span class="co">## 1 2025-02-06     13-06-34 001-001         RH  H10b                 0,0                 0,0       C57 P79   F 1156.0</span></span>
<span><span class="co">## 2 2025-02-06     14-03-05 001-002         RH  H10b                 0,0                 0,0       C57 P79   F 1209.0</span></span>
<span><span class="co">## 3 2025-02-06     15-36-59 001-004         RH  H10b                 0,0                 0,0       C57 P79   F 1003.0</span></span>
<span><span class="co">## 4 2025-02-06     15-53-03 001-005         RH  H10b                 0,0                 0,0       C57 P79   F 1003.0</span></span>
<span><span class="co">## 5 2025-02-20     16-19-12 001-001         RH  H10b                 0,0                 0,0 Mecp2 HET P79   F 1191.4</span></span>
<span><span class="co">## 6 2025-02-20     17-04-02 001-002         RH  H10b                 0,0                 0,0 Mecp2 HET P79   F 1191.4</span></span></code></pre>
<p>The neurons package (as of v1.0) can only handle certain covariates,
and expects them to have specific names (<strong>type</strong>,
<strong>genotype</strong>, <strong>sex</strong>, <strong>hemi</strong>,
<strong>region</strong>, <strong>age</strong>). The package also expects
the dataframe holding those covariates to have rows labeled with
recording names that match the format of the recording names in the
data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Format and apply recording names to metadata as row names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">kilo4_metadata</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="va">kilo4_metadata</span><span class="op">$</span><span class="va">DAY</span>, </span>
<span>    <span class="st">"_"</span>,</span>
<span>    <span class="va">kilo4_metadata</span><span class="op">$</span><span class="va">Neuralynx_ID</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Keep only the relevant columns (covariates of interest)</span></span>
<span><span class="va">kilo4_metadata</span> <span class="op">&lt;-</span> <span class="va">kilo4_metadata</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HEMISPHERE"</span>,<span class="st">"STRAIN"</span>,<span class="st">"AGE"</span>,<span class="st">"SEX"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Rename columns to match what's expected by neurons package </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">kilo4_metadata</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hemi"</span>, <span class="st">"genotype"</span>, <span class="st">"age"</span>, <span class="st">"sex"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">kilo4_metadata</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                     hemi  genotype age sex</span></span>
<span><span class="co">## 2025-02-06_13-06-34   RH       C57 P79   F</span></span>
<span><span class="co">## 2025-02-06_14-03-05   RH       C57 P79   F</span></span>
<span><span class="co">## 2025-02-06_15-36-59   RH       C57 P79   F</span></span>
<span><span class="co">## 2025-02-06_15-53-03   RH       C57 P79   F</span></span>
<span><span class="co">## 2025-02-20_16-19-12   RH Mecp2 HET P79   F</span></span>
<span><span class="co">## 2025-02-20_17-04-02   RH Mecp2 HET P79   F</span></span></code></pre>
<h2>
Preprocess data into spike rasters
</h2>
<p>The function <a href="../reference/preprocess.kilo4.html">preprocess.kilo4</a> converts
cluster spike times into spike rasters of the standardized format
expected by the neurons package.</p>
<h3>
Parsing trials and quality control
</h3>
<p>The output of kilosort4 must be partitioned into trials, which <a href="../reference/preprocess.kilo4.html">preprocess.kilo4</a> does with
start and stop times relative to a stimulus specified in
<strong>StimulusStamps.csv</strong>. For example, information about
responses to stimuli can be analyzed by setting the start time to
something negative (before the stimulus) and the end time to something
positive (after the stimulus). However, for estimating autocorrelation,
it’s the spontaneous activity during a period of silence after the
stimulus which should be analyzed. In this case, the start time should
be some time after the stimulus (to allow for settling) and the end time
some time later.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spike.rasters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preprocess.kilo4.html">preprocess.kilo4</a></span><span class="op">(</span></span>
<span>    trial_time_start <span class="op">=</span> <span class="fl">500</span>,      <span class="co"># ms</span></span>
<span>    trial_time_end <span class="op">=</span> <span class="fl">500</span> <span class="op">+</span> <span class="fl">1520</span>, <span class="co"># ms</span></span>
<span>    recording.folder <span class="op">=</span> <span class="va">demo_data</span>,</span>
<span>    meta_data <span class="op">=</span> <span class="va">kilo4_metadata</span>, </span>
<span>    max_spikes <span class="op">=</span> <span class="fl">1e4</span>,</span>
<span>    min_spikes <span class="op">=</span> <span class="fl">1e2</span>,</span>
<span>    min_trials <span class="op">=</span> <span class="fl">1e2</span>,</span>
<span>    pure_trials_only <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    good_cells_only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    stim_responsive_only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> </span></code></pre></div>
<p>A path (such as <strong>demo_data</strong>) for the actual data must
be passed to <a href="../reference/preprocess.kilo4.html">preprocess.kilo4</a>. Metadata
(such as <strong>kilo4_metadata</strong>) will usually be provided, but
is not necessary for the function to run. If left out, the preprocessed
output will simply lack information about covariates.</p>
<p>In addition to the start and stop times and pointers to the data, <a href="../reference/preprocess.kilo4.html">preprocess.kilo4</a> has three
Boolean variables controlling the quality of clusters extracted for
further analysis:</p>
<ul>
<li>
<strong>pure_trials_only</strong>: include only trials which do not
overlap with other trials (i.e., do not have a start time before the end
time of any previous trials)?</li>
<li>
<strong>good_cells_only</strong>: include only spike clusters which
passed hand curation?</li>
<li>
<strong>stim_responsive_only</strong>: include only spike clusters
which are responsive to stimuli?</li>
</ul>
<p>Three additional numeric variables are also useful for quality
control:</p>
<ul>
<li>
<strong>max_spikes</strong>: maximum number of spikes a cluster can
have to be extracted</li>
<li>
<strong>min_spikes</strong>: minimum number of spikes a cluster must
have to be extracted</li>
<li>
<strong>min_trials</strong>: minimum number of trials a cluster must
have to be extracted</li>
</ul>
<p>Finally, if <strong>verbose</strong> is set to TRUE, the function
will print out information about the files it is finding and
parsing.</p>
<h3>
Raster format
</h3>
<p>The output of <a href="../reference/preprocess.kilo4.html">preprocess.kilo4</a>, in this
case <strong>spike.rasters</strong>, is a list with three elements:
<strong>spikes</strong>, <strong>timeXtrial</strong>, and
<strong>cluster.key</strong>. The first element,
<strong>spikes</strong>, is a single dataframe giving a compact
spike-indexed representation of the spike rasters (plus covariates) from
all recordings. Each row is a spike, with columns giving information
such as cell number, time, and genotype.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spike.rasters</span><span class="op">$</span><span class="va">spikes</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      trial   sample cell time_in_ms      recording_name cluster hemi  genotype age sex</span></span>
<span><span class="co">## 3767     1 6881.530    1   503.2369 2025-04-05_11-50-43      17   RH Mecp2 HET P64   F</span></span>
<span><span class="co">## 3768     1 6884.632    2   506.3389 2025-04-05_11-50-43      34   RH Mecp2 HET P64   F</span></span>
<span><span class="co">## 3770     1 6888.790    3   510.4969 2025-04-05_11-50-43      82   RH Mecp2 HET P64   F</span></span>
<span><span class="co">## 3772     1 6892.552    4   514.2589 2025-04-05_11-50-43       1   RH Mecp2 HET P64   F</span></span>
<span><span class="co">## 3781     1 6903.673    5   525.3799 2025-04-05_11-50-43      12   RH Mecp2 HET P64   F</span></span>
<span><span class="co">## 3783     1 6906.115    2   527.8219 2025-04-05_11-50-43      34   RH Mecp2 HET P64   F</span></span></code></pre>
<p>The second element, <strong>timeXtrial</strong>, is a list of
matrices, one per cell, with rows corresponding to time bins and columns
to trials. Each entry is a binary indicator of whether the cell fired in
that time bin during that trial. Thus, <strong>timeXtrial</strong>
contains the rasters of <strong>spikes</strong> in a verbose
time-indexed format.</p>
<p>The third element, <strong>cluster.key</strong>, is a dataframe with
rows representing clusters (i.e., “cells”) and columns giving
information such as cell number, genotype, and number of spikes.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spike.rasters</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        recording.name cell cluster num.of.spikes num.of.responsive.trials hemi  genotype age sex</span></span>
<span><span class="co">## 1 2025-04-05_11-50-43    1      17          1869                      337   RH Mecp2 HET P64   F</span></span>
<span><span class="co">## 2 2025-04-05_11-50-43    2      34          1457                      271   RH Mecp2 HET P64   F</span></span>
<span><span class="co">## 3 2025-04-05_11-50-43    3      82          2321                      325   RH Mecp2 HET P64   F</span></span>
<span><span class="co">## 4 2025-04-05_11-50-43    4       1          2461                      396   RH Mecp2 HET P64   F</span></span>
<span><span class="co">## 5 2025-04-05_11-50-43    5      12          4153                      355   RH Mecp2 HET P64   F</span></span>
<span><span class="co">## 6 2025-04-05_11-50-43    6      95          2263                      360   RH Mecp2 HET P64   F</span></span></code></pre>
<h3>
Cluster summary
</h3>
<p>Important summary information can be pulled from
<strong>cluster.key</strong>. For example, how many cells were included
in the output?</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">spike.rasters</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of cells included:"</span>, <span class="va">n_cells</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Number of cells included: 37</span></span></code></pre>
<p>The number of cells and summary statistics, such as mean spike and
trial count, can be pulled for each covariate combination as well. While
this can be done with minimal code by hand, the function <a href="../reference/summarize.cluster.key.html">summarize.cluster.key</a>
automates this process.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Print results </span></span>
<span><span class="va">covariate_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summarize.cluster.key.html">summarize.cluster.key</a></span><span class="op">(</span></span>
<span>    key <span class="op">=</span> <span class="va">spike.rasters</span><span class="op">$</span><span class="va">cluster.key</span>, </span>
<span>    covariate_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"genotype"</span>, <span class="st">"hemi"</span>, <span class="st">"sex"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">covariate_summary</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     genotype hemi sex n_cells mean_spikes mean_trials</span></span>
<span><span class="co">## 1  Mecp2 HET   RH   F      26      1946.9       324.2</span></span>
<span><span class="co">## 2  Shank3 KO   RH   F      NA          NA          NA</span></span>
<span><span class="co">## 3        C57   RH   F      NA          NA          NA</span></span>
<span><span class="co">## 4  Mecp2 HET   LH   F      NA          NA          NA</span></span>
<span><span class="co">## 5  Shank3 KO   LH   F       1      1334.0       297.0</span></span>
<span><span class="co">## 6        C57   LH   F       1      2587.0       449.0</span></span>
<span><span class="co">## 7  Mecp2 HET   RH   M      NA          NA          NA</span></span>
<span><span class="co">## 8  Shank3 KO   RH   M      NA          NA          NA</span></span>
<span><span class="co">## 9        C57   RH   M      NA          NA          NA</span></span>
<span><span class="co">## 10 Mecp2 HET   LH   M      NA          NA          NA</span></span>
<span><span class="co">## 11 Shank3 KO   LH   M       9       728.0       173.0</span></span>
<span><span class="co">## 12       C57   LH   M      NA          NA          NA</span></span></code></pre>
<p>Thus, for Mecp2 HET mice, 26 clusters from the right hemisphere of
females passed the quality control, with none from males or the left
hemisphere. For Shank3 KO mice, 9 clusters passed from the left
hemisphere of males and 1 from the left hemisphere of females, with none
from the right hemisphere. For C57 (wildtype) mice, 1 cluster passed
from the left hemisphere of females, with none from males or the right
hemisphere.</p>
<h2>
Converting to neurons
</h2>
<p>With the kilosort4 data preprocessed into spike rasters, the next
step is to use the function <a href="../reference/load.rasters.as.neurons.html">load.rasters.as.neurons</a>
to convert these rasters into a special class of object from the neuron
package, <strong>neuron</strong>. This function will convert all
clusters appearing in the raster into individual <strong>neuron</strong>
objects and return them in a list.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">neurons</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load.rasters.as.neurons.html">load.rasters.as.neurons</a></span><span class="op">(</span></span>
<span>    <span class="va">spike.rasters</span><span class="op">$</span><span class="va">spikes</span>, </span>
<span>    bin_size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sample_rt <span class="op">=</span> <span class="fl">1e3</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Class <strong>neuron</strong> comes with built-in methods for
plotting rasters, plotting autocorrelation, and estimating
autocorrelation parameters with dichotomized Gaussian simulations. These
methods can be accessed directly via the Rcpp objects, or through
wrappers provided by the neurons package.</p>
<h3>
Visualizing autocorrelation
</h3>
<p>For example, here is the raster from one cell, plotted with the <a href="../reference/plot.raster.html">plot.raster</a> wrapper:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_high</span> <span class="op">&lt;-</span> <span class="fl">25</span></span>
<span><span class="fu"><a href="../reference/plot-raster.html">plot.raster</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">cell_high</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </span></code></pre></div>
<p><img src="tutorial_tau_est_kilosort_files/figure-html/plot_raster_high_autocor-1.png" width="700"></p>
<p>This cell exhibits high autocorrelation, as can be seen by the long
horizontal streaks of spikes. Contrast this raster with one from a cell
with low autocorrelation:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_low</span> <span class="op">&lt;-</span> <span class="fl">13</span></span>
<span><span class="fu"><a href="../reference/plot-raster.html">plot.raster</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">cell_low</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </span></code></pre></div>
<p><img src="tutorial_tau_est_kilosort_files/figure-html/plot_raster_low_autocor-1.png" width="700"></p>
<p>Notice how the raster for this cell shows more randomly scattered
spikes, with fewer (almost no) long streaks. The streaks absent here,
but present in the previous raster, are a manifestation of
autocorrelation, i.e., the tendency of a spike now to increase the
probability of a spike later.</p>
<h3>
Empirical autocorrelation and exponential decay fits
</h3>
<p>Beyond visualizing it as streaks in a raster, autocorrelation can be
quantified both by using the raster data to compute the empirical
correlation between spikes separated by different lag times (empirical
autocorrelation), and by fitting an exponential decay model to those
empirically estimated spike correlations. The empirical autocorrelation
can be computed with centering-and-normalization, or without (i.e., “raw
autocorrelation”). The <a href="tutorial_tau_est_DG.html">tutorial on
estimating network time constants</a> provides a comparison between
empirical vs population autocorrelation, and centered-and-normalized vs
raw autocorrelation. The class <strong>neuron</strong> provides a method
for computing both versions of empirical autocorrelation, and the
neurons package provides a wrapper <a href="../reference/compute.autocorr.html">compute.autocorr</a> with
default parameters to access it. Similarly, there is a method and
corresponding wrapper <a href="../reference/fit.edf.autocorr.html">fit.edf.autocorr</a> for
fitting a decay model to the empirical estimate. Here, for example,
these wrappers applied to the above cells:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># High autocorrelation cell</span></span>
<span><span class="fu"><a href="../reference/compute.autocorr.html">compute.autocorr</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">cell_high</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fit.edf.autocorr.html">fit.edf.autocorr</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">cell_high</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Low autocorrelation cell</span></span>
<span><span class="fu"><a href="../reference/compute.autocorr.html">compute.autocorr</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">cell_low</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fit.edf.autocorr.html">fit.edf.autocorr</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">cell_low</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>The results can be visualized by using the <a href="../reference/plot.autocorrelation.html">plot.autocorrelation</a>
function to plot both the computed empirical autocorrelation and fitted
exponential decay in empirical autocorrelation. Here is the
high-autocorrelation cell:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot-autocorrelation.html">plot.autocorrelation</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">cell_high</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_tau_est_kilosort_files/figure-html/plot_autocor_high-1.png" width="700"></p>
<p>Here is the plot for the low-autocorrelation cell:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot-autocorrelation.html">plot.autocorrelation</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">cell_low</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </span></code></pre></div>
<p><img src="tutorial_tau_est_kilosort_files/figure-html/plot_autocor_low-1.png" width="700"></p>
<p>The parameters of the exponential decay fit can be fetched directly
with a neuron method and provide succinct quantification of the
empirical autocorrelation.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fetch and print exponential decay parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">cell_high</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">fetch_EDF_parameters</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            A          tau    bias_term </span></span>
<span><span class="co">## 0.0010000000 5.0000000000 0.0003080561</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fetch and print exponential decay parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">cell_low</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">fetch_EDF_parameters</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            A          tau    bias_term </span></span>
<span><span class="co">## 4.538731e-03 5.000139e+00 6.807511e-06</span></span></code></pre>
<p>The amplitude,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>,
gives the autocorrelation at lag time 1 (minus the bias), while the time
constant,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
(tau), gives the rate of decay in autocorrelation as lag time increases.
Notice how the high-autocorrelation cell has a time constant of 131ms
and an amplitude of 0.07, while the low-autocorrelation cell has a time
constant of only 20ms and an amplitude of 0.006.</p>
<p>In practice, the individual steps shown above do not need to be run
with separate method calls. The neurons package provides a function, <a href="../reference/process.autocorr.html">process.autocorr</a>, which
does all of these steps in one call for a list of neurons.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">autocor.results.batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process.autocorr.html">process.autocorr</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">autocor.results.batch</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       cell   lambda_ms  lambda_bin           A      tau    bias_term   autocorr1 max_autocorr mean_autocorr min_autocorr</span></span>
<span><span class="co">## 1 neuron_1 0.002458518 0.012292591 0.009056644 12.72122 0.0001511078 0.009207752  0.006264335  0.0002131866 0.0001511078</span></span>
<span><span class="co">## 2 neuron_2 0.001918199 0.009590996 0.007685403 11.53797 0.0000919872 0.007777390  0.005074683  0.0001387488 0.0000919872</span></span>
<span><span class="co">## 3 neuron_3 0.003054323 0.015271613 0.009896467 18.74262 0.0002332222 0.010129689  0.007812410  0.0003400494 0.0002332222</span></span>
<span><span class="co">## 4 neuron_4 0.003245878 0.016229391 0.011568551 12.92319 0.0002633931 0.011831945  0.008120267  0.0003442126 0.0002633931</span></span>
<span><span class="co">## 5 neuron_5 0.005471888 0.027359438 0.024046202 20.06005 0.0007485388 0.024794741  0.019489760  0.0010289001 0.0007485388</span></span>
<span><span class="co">## 6 neuron_6 0.002979021 0.014895107 0.012270280 11.95191 0.0002218642 0.012492144  0.008297382  0.0002998248 0.0002218642</span></span></code></pre>
<h2>
Estimating population autocorrelation
</h2>
<p>Recall that the aim is to estimate the network time constant for
covariates of interest, e.g.,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
in the right vs left hemisphere of C57 (wildtype) mice, or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
in the right hemisphere of C57 vs Shank3 KO mice. That is, the aim is
not only to compute the empirical autocorrelation of a finite sample,
but to estimate population values. At first glance, the output of <a href="../reference/process.autocorr.html">process.autocorr</a> appears
to provide all that’s needed for this estimation. Why not simply take
the covariate means of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
values listed in the output of <a href="../reference/process.autocorr.html">process.autocorr</a>?</p>
<h3>
The problem
</h3>
<p>The problem is that recurrence is very noisy, the amount of data
available from which to extract a signal through all that noise is low,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
itself is an imperfect measure of the network time constant. To see the
problem, consider the lone cluster from a C57 mouse in the demo data.
Obviously a single data point is not enough to estimate the population
value of a variable, but even this single data point is an unreliable
estimate of the true network time constant of this one individual cell.
Consider what happens when a slightly different initial condition is
used in the fit of the exponential decay model. First, set the initial
amplitude to 0.001 (the default value in neurons):</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set cell number</span></span>
<span><span class="va">C57_cell_num</span> <span class="op">&lt;-</span> <span class="fl">37</span></span>
<span><span class="fu"><a href="../reference/fit.edf.autocorr.html">fit.edf.autocorr</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">C57_cell_num</span><span class="op">]</span><span class="op">]</span>, A0 <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span>
<span><span class="va">C57_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot-autocorrelation.html">plot.autocorrelation</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">C57_cell_num</span><span class="op">]</span><span class="op">]</span>, return_plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">C57_cell_num</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">fetch_EDF_parameters</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           A         tau   bias_term </span></span>
<span><span class="co">##  0.01517868 10.57577455  0.00034827</span></span></code></pre>
<p>With this initial condition,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
is 378 ms. Now, set the initial amplitude to 0.01:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fit.edf.autocorr.html">fit.edf.autocorr</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">C57_cell_num</span><span class="op">]</span><span class="op">]</span>, A0 <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">[[</span><span class="va">C57_cell_num</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">fetch_EDF_parameters</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          A        tau  bias_term </span></span>
<span><span class="co">## 0.01761368 9.20938982 0.00034827</span></span></code></pre>
<p>With this initial condition,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
is now 2 ms.</p>
<p>What’s happening? Consider the autocorrelation plot resulting from
the first fit with a low initial amplitude and high
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">C57_plot</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_tau_est_kilosort_files/figure-html/fit_variability2_plot-1.png" width="700"></p>
<p>Notice the blue line, which gives the computed empirical
autocorrelation as a function of lag. The exponential component of the
blue line is clearly small, with its initial peak amplitude
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
only slightly larger than its baseline bias. Given the exponential decay
model (the red line):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>A</mi><mo>*</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>−</mi><mtext mathvariant="normal">lag</mtext><mi>/</mi><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mtext mathvariant="normal">bias</mtext></mrow><annotation encoding="application/x-tex">y = A * \exp(-\text{lag}/\tau) + \text{bias}</annotation></semantics></math></p>
<p>this behavior can be accommodated in two ways: either neuron 37 has a
low baseline autocorrelation that decays slowly (low
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>,
high
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>),
or it has a high baseline autocorrelation that decays quickly (high
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>,
low
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>).
These are the two solutions the optimization algorithm finds, depending
on the initial conditions. The upshot is that the data is simply too
noisy to decide between them. More generally, unless <em>both</em>
autocorrelation and the network time constant are relatively high (e.g.,
as with neuron 25 with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi><mo>=</mo><mn>131</mn></mrow><annotation encoding="application/x-tex">\tau=131</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mn>0.07</mn></mrow><annotation encoding="application/x-tex">A=0.07</annotation></semantics></math>),
noise will quickly dominate and the estimated
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
will depend on initial conditions.</p>
<h3>
Dichotomized Gaussians
</h3>
<p>Thus, exponential decay fits to computed empirical autocorrelation
are often not reliable estimates of the network time constant, even for
individual neurons. Any statistical method for estimating the population
network time constant for a covariate of interest based on these
unreliable individual estimates (e.g., bootstrapping) will only amplify
the noise. The solution is to estimate the network time constant from
simulations, not the observed data itself. Specifically, <a href="tutorial_tau_est_DG.html">dichotomized Gaussians</a> can be used
to generate simulated spike trains consistent with the observed data.
The exponential decay model can be fit to each simulation, yielding a
distribution of possible
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
values for each neuron. For the purpose of speed, this tutorial runs
only 100 simulations per neuron, but in practice, 1000 or more
simulations should be run.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">autocor.ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate.autocorr.params.html">estimate.autocorr.params</a></span><span class="op">(</span></span>
<span>    neuron_list <span class="op">=</span> <span class="va">neurons</span>,</span>
<span>    n_trials_per_sim <span class="op">=</span> <span class="fl">500</span>, </span>
<span>    n_sims_per_neurons <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>With the simulations run, the final step is to estimate the network
time constant for covariates of interest. The function <a href="../reference/analyze.autocorr.html">analyze.autocorr</a> does this
by bootstrapping over the tau values obtained from the simulations. If
there are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
neurons in a covariate level,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
simulations have been run per neuron, then each bootstrap resample
consists of the mean of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
draws with replacement from the pool of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">nm</annotation></semantics></math>
values for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>.
For this tutorial, 10k bootstrap resamples are used.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run analysis</span></span>
<span><span class="va">autocor.results.bootstraps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/analyze.autocorr.html">analyze.autocorr</a></span><span class="op">(</span></span>
<span>  <span class="va">autocor.ests</span>,</span>
<span>  covariate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hemi"</span>,<span class="st">"genotype"</span><span class="op">)</span>,</span>
<span>  n_bs <span class="op">=</span> <span class="fl">1e4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The function <a href="../reference/analyze.autocorr.html">analyze.autocorr</a> returns a
list with two objects. The first is <strong>resamples</strong>, a
dataframe holding the tau values for each covariate from each
simulation.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">autocor.results.bootstraps</span><span class="op">$</span><span class="va">resamples</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   RH_Mecp2 HET LH_Shank3 KO   LH_C57</span></span>
<span><span class="co">## 1     20.40157     20.96111 9.168224</span></span>
<span><span class="co">## 2     20.43003     23.46845 9.193223</span></span>
<span><span class="co">## 3     16.97245     25.84013 9.141002</span></span>
<span><span class="co">## 4     21.23175     16.88663 9.266323</span></span>
<span><span class="co">## 5     18.58005     20.01192 9.415530</span></span>
<span><span class="co">## 6     19.12619     25.10195 9.211303</span></span></code></pre>
<p>The second is <strong>distribution_plot</strong>, a ggplot2 object
visualizing the bootstrap distributions of tau for each covariate.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">autocor.results.bootstraps</span><span class="op">$</span><span class="va">distribution_plot</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_tau_est_kilosort_files/figure-html/plot_distribution-1.png" width="700"></p>
<h2>
Code summary
</h2>
<p>The essential steps to run this analysis are as follows:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setup</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Load and format metadata</span></span>
<span><span class="va">kilo4_metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span></span>
<span>    <span class="st">"extdata"</span>, </span>
<span>    <span class="st">"meta_data_kilo4demo.csv"</span>, </span>
<span>    package <span class="op">=</span> <span class="st">"neurons"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">kilo4_metadata</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="va">kilo4_metadata</span><span class="op">$</span><span class="va">DAY</span>, </span>
<span>  <span class="st">"_"</span>,</span>
<span>  <span class="va">kilo4_metadata</span><span class="op">$</span><span class="va">Neuralynx_ID</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">kilo4_metadata</span> <span class="op">&lt;-</span> <span class="va">kilo4_metadata</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HEMISPHERE"</span>,<span class="st">"STRAIN"</span>,<span class="st">"AGE"</span>,<span class="st">"SEX"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">kilo4_metadata</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hemi"</span>, <span class="st">"genotype"</span>, <span class="st">"age"</span>, <span class="st">"sex"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load data spike and stimulus data</span></span>
<span><span class="va">spike.rasters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preprocess.kilo4.html">preprocess.kilo4</a></span><span class="op">(</span></span>
<span>  trial_time_start <span class="op">=</span> <span class="fl">500</span>,      <span class="co"># ms</span></span>
<span>  trial_time_end <span class="op">=</span> <span class="fl">500</span> <span class="op">+</span> <span class="fl">1520</span>, <span class="co"># ms</span></span>
<span>  recording.folder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span></span>
<span>    <span class="st">"extdata"</span>, </span>
<span>    <span class="st">"kilo4demo"</span>, </span>
<span>    package <span class="op">=</span> <span class="st">"neurons"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  meta_data <span class="op">=</span> <span class="va">kilo4_metadata</span>, </span>
<span>  max_spikes <span class="op">=</span> <span class="fl">1e4</span>,</span>
<span>  min_spikes <span class="op">=</span> <span class="fl">1e2</span>,</span>
<span>  min_trials <span class="op">=</span> <span class="fl">1e2</span>,</span>
<span>  pure_trials_only <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  good_cells_only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  stim_responsive_only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Make neurons</span></span>
<span><span class="va">neurons</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load.rasters.as.neurons.html">load.rasters.as.neurons</a></span><span class="op">(</span></span>
<span>  <span class="va">spike.rasters</span><span class="op">$</span><span class="va">spikes</span>, </span>
<span>  sample_rt <span class="op">=</span> <span class="fl">1e3</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Run simulations</span></span>
<span><span class="va">autocor.ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate.autocorr.params.html">estimate.autocorr.params</a></span><span class="op">(</span></span>
<span>  neuron_list <span class="op">=</span> <span class="va">neurons</span>,</span>
<span>  n_trials_per_sim <span class="op">=</span> <span class="fl">500</span>, </span>
<span>  n_sims_per_neurons <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Run analysis</span></span>
<span><span class="va">autocor.results.bootstraps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/analyze.autocorr.html">analyze.autocorr</a></span><span class="op">(</span></span>
<span>  <span class="va">autocor.ests</span>,</span>
<span>  covariate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hemi"</span>,<span class="st">"genotype"</span><span class="op">)</span>,</span>
<span>  n_bs <span class="op">=</span> <span class="fl">1e4</span></span>
<span><span class="op">)</span></span></code></pre></div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Barkasi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
