<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Dichotomized Gaussian analysis of KiloSort4 data â€¢ neurons</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Dichotomized Gaussian analysis of KiloSort4 data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">neurons</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Introduction</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Package Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Installation</h6></li>
    <li><a class="dropdown-item" href="../articles/install.html">Installation instructions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/tutorial_DG_analysis_of_kilosort.html">Dichotomized Gaussian analysis of KiloSort4 data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Legal</h6></li>
    <li><a class="dropdown-item" href="../articles/license.html">Dependency licenses</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/michaelbarkasi/neurons"><span class="fa fab fa-github"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../#">ðŸŒ™</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Dichotomized Gaussian analysis of KiloSort4 data</h1>
            
      

      <div class="d-none name"><code>tutorial_DG_analysis_of_kilosort.Rmd</code></div>
    </div>

    
    
<p>This tutorial shows how to use the neurons package to run a
dichotomized Gaussian (DG) analysis of autocorrelation on KiloSort4
data. The aim of this DG analysis of autocorrelation is to estimate the
network time constant of single neurons in the left and right hemisphere
of various genotypes of mice. Network time constants provide an estimate
of recurrence. Specifically, a higher network time constant indicates
that a neuron receives a larger number of projections back on itself.
Intuitively, the longer into the future a spike <em>now</em> increases
the probability of a spike <em>later</em>, the stronger the connections
from that neuron back onto itself must be.</p>
<h1>
Setup
</h1>
<p>The first step is to set up the R environment by clearing the
workspace, setting a random-number generator seed, and loading the
neurons package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clear the R workspace to start fresh</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Load neurons package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">neurons</span><span class="op">)</span> </span></code></pre></div>
<h1>
Load data
</h1>
<p>This tutorial uses data recorded by multi-channel probes from the
auditory cortex of mice with spike clusters extracted with kilosort4,
plus a csv file with stimulus event information. A path to the data must
be provided.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set path to data </span></span>
<span><span class="va">demo_data</span> <span class="op">&lt;-</span> <span class="st">"/Users/michaelbarkasi/Library/CloudStorage/OneDrive-WashingtonUniversityinSt.Louis/projects_Oviedo_lab/_lateralized_recurrent_pathways/dichot-gaussian/data_demo"</span></span></code></pre></div>
<p>The function <strong>preprocess.kilo4</strong> (from the neurons
package) will be used to process the data. This function expects
<strong>data_path</strong> to point to a folder the subfolders of which
each contain a single kilosort4 output. This output should be in its own
folder <strong>kilosort4</strong>. While kilosort outputs many files,
only six are needed:</p>
<ul>
<li>
<strong>spike_positions.npy</strong>: 2D array giving the x and y
position of each spike<br>
</li>
<li>
<strong>spike_clusters.npy</strong>: integer giving the cluster
number of each spike<br>
</li>
<li>
<strong>spike_times.npy</strong>: sample number the spike occurred
at<br>
</li>
<li>
<strong>cluster_group.tsv</strong>: 2D array giving status of each
cluster (0=noise, 1=MUA, 2=Good, 3=unsorted), hand-curated<br>
</li>
<li>
<strong>cluster_info.tsv</strong>: 2D array giving the automatic
output of kilosort4; not needed if cluster_group.tsv has data.</li>
<li>
<strong>includeVector.mat</strong>: MATLAB file giving whether each
cluster is stimulus-responsive (1) or not (0)</li>
</ul>
<p>More of the kilosort4 output files can be included, but only the
above files (minus <strong>cluster_info.tsv</strong>) are required. In
addition, along with the kilosort4 subfolder, there should be a file
<strong>StimulusStamps.csv</strong> in each recording folder.</p>
<div class="figure">
<img src="fig_folderstructure.png" alt="Image showing folder structure necessary for &lt;b&gt;preprocess.kilo4&lt;/b&gt; function." width="90%"><p class="caption">
Folder structure necessary for <b>preprocess.kilo4</b> function.
</p>
</div>
<p>Meta data can also be pulled from the recordings. For this tutorial,
the csv file with that data is in the neurons package itself. It can be
loaded with the regular <strong>read.csv</strong> function in R.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load </span></span>
<span><span class="va">kilo4_metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span></span>
<span>    <span class="st">"extdata"</span>, </span>
<span>    <span class="st">"meta_data_kilo4demo.csv"</span>, </span>
<span>    package <span class="op">=</span> <span class="st">"neurons"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">kilo4_metadata</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          DAY Neuralynx_ID   EXPER HEMISPHERE PROBE COORDINATES_SHANK_1 COORDINATES_SHANK_2    STRAIN AGE SEX  DEPTH</span></span>
<span><span class="co">## 1 2025-02-06     13-06-34 001-001         RH  H10b                 0,0                 0,0       C57 P79   F 1156.0</span></span>
<span><span class="co">## 2 2025-02-06     14-03-05 001-002         RH  H10b                 0,0                 0,0       C57 P79   F 1209.0</span></span>
<span><span class="co">## 3 2025-02-06     15-36-59 001-004         RH  H10b                 0,0                 0,0       C57 P79   F 1003.0</span></span>
<span><span class="co">## 4 2025-02-06     15-53-03 001-005         RH  H10b                 0,0                 0,0       C57 P79   F 1003.0</span></span>
<span><span class="co">## 5 2025-02-20     16-19-12 001-001         RH  H10b                 0,0                 0,0 Mecp2 HET P79   F 1191.4</span></span>
<span><span class="co">## 6 2025-02-20     17-04-02 001-002         RH  H10b                 0,0                 0,0 Mecp2 HET P79   F 1191.4</span></span></code></pre>
<p>For statistical analysis, covariates of interest are all thatâ€™s
needed from the meta data file. The neurons package (as of v1.0) can
only handle certain covariates, and expects them to have specific names
(type, genotype, sex, hemi, region, age). The package also expects the
data frame holding those covariates to have rows labeled with recording
names that match the format of the recording names in the data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Format and apply recording names to metadata as row names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">kilo4_metadata</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="va">kilo4_metadata</span><span class="op">$</span><span class="va">DAY</span>, </span>
<span>  <span class="st">"_"</span>,</span>
<span>  <span class="va">kilo4_metadata</span><span class="op">$</span><span class="va">Neuralynx_ID</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Keep only the relevant columns (covariates of interest)</span></span>
<span><span class="va">kilo4_metadata</span> <span class="op">&lt;-</span> <span class="va">kilo4_metadata</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HEMISPHERE"</span>,<span class="st">"STRAIN"</span>,<span class="st">"AGE"</span>,<span class="st">"SEX"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Rename columns to match what's expected by neurons package </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">kilo4_metadata</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hemi"</span>, <span class="st">"genotype"</span>, <span class="st">"age"</span>, <span class="st">"sex"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">kilo4_metadata</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                     hemi  genotype age sex</span></span>
<span><span class="co">## 2025-02-06_13-06-34   RH       C57 P79   F</span></span>
<span><span class="co">## 2025-02-06_14-03-05   RH       C57 P79   F</span></span>
<span><span class="co">## 2025-02-06_15-36-59   RH       C57 P79   F</span></span>
<span><span class="co">## 2025-02-06_15-53-03   RH       C57 P79   F</span></span>
<span><span class="co">## 2025-02-20_16-19-12   RH Mecp2 HET P79   F</span></span>
<span><span class="co">## 2025-02-20_17-04-02   RH Mecp2 HET P79   F</span></span></code></pre>
<h1>
Preprocess data into spike rasters
</h1>
<p>The function <strong>preprocess.kilo4</strong> converts raw cluster
spike times into spike rasters of a standardized format expected by the
neurons package. The recordings must be partitioned into trials, which
<strong>preprocess.kilo4</strong> does with start and stop times
relative to a stimulus. For example, information about responses to
stimuli can be analyzed by setting the start time to something negative
(before the stimulus) and the end time to something positive (after the
stimulus). However, for estimating autocorrelation, itâ€™s the spontaneous
activity during a period of silence after the stimulus which should be
analyzed. In this case, the start time should be some time after the
stimulus (to allow for settling) and the end time some time later.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spike.rasters.kilo4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preprocess.kilo4.html">preprocess.kilo4</a></span><span class="op">(</span></span>
<span>  trial_time_start <span class="op">=</span> <span class="fl">500</span>,      <span class="co"># ms</span></span>
<span>  trial_time_end <span class="op">=</span> <span class="fl">500</span> <span class="op">+</span> <span class="fl">1520</span>, <span class="co"># ms</span></span>
<span>  recording.folder <span class="op">=</span> <span class="va">demo_data</span>,</span>
<span>  meta_data <span class="op">=</span> <span class="va">kilo4_metadata</span>, </span>
<span>  min_spikes <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  min_trials <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  pure_trials_only <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  good_cells_only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  stim_responsive_only <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span> </span></code></pre></div>
<p>A path (such as <strong>demo_data</strong>) for the actual data must
be passed to <strong>preprocess.kilo4</strong>. Meta data (such as
<strong>kilo4_metadata</strong>) can also be provided, but is not
necessary. If left out, the preprocessed output will simply lack
information about covariates.</p>
<p>In addition to the start and stop times and pointers to the data,
<strong>preprocess.kilo4</strong> has four Boolean variables,
<strong>pure_trials_only</strong>, <strong>good_cells_only</strong>,
<strong>stim_responsive_only</strong>, and <strong>verbose</strong>. The
first, <strong>pure_trials_only</strong>, controls whether trials which
overlap with another (i.e., have a start time before the end time of any
previous trials) are included in the data. The second,
<strong>good_cells_only</strong>, controls whether spike clusters are
included without passing hand curation. Likewise, the third,
<strong>stim_responsive_only</strong> controls whether spike clusters
are included without being responsive to stimului. Finally, if
<strong>verbose</strong> is set to TRUE, the function will print out
information about the files it is finding and parsing.</p>
<p>A floor can be set for the minimum number of spikes
(<strong>min_spikes</strong>) and trials (<strong>min_trials</strong>) a
cell must have to be included in the output. Cells with fewer spikes or
trials will be excluded.</p>
<p>The output <strong>spike.rasters.kilo4</strong> is a list with three
elements: <strong>spikes</strong>, <strong>timeXtrial</strong>, and
<strong>cluster.key</strong>. The first element,
<strong>spikes</strong>, is a data frame giving a sparse representation
of the spike rasters from each recording. Each row is a spike, with
columns giving information such as cell number, time, and genotype. Here
are the first few rows of the <strong>spikes</strong> data frame:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">spikes</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      trial   sample cell time_in_ms      recording_name cluster hemi genotype age sex</span></span>
<span><span class="co">## 2881     1 8379.566    1   501.2114 2025-04-03_11-18-50     103   RH      C57 P41   F</span></span>
<span><span class="co">## 2882     1 8379.632    2   501.2774 2025-04-03_11-18-50      66   RH      C57 P41   F</span></span>
<span><span class="co">## 2883     1 8388.014    3   509.6594 2025-04-03_11-18-50      62   RH      C57 P41   F</span></span>
<span><span class="co">## 2884     1 8396.165    1   517.8104 2025-04-03_11-18-50     103   RH      C57 P41   F</span></span>
<span><span class="co">## 2885     1 8396.297    2   517.9424 2025-04-03_11-18-50      66   RH      C57 P41   F</span></span>
<span><span class="co">## 2886     1 8404.547    4   526.1924 2025-04-03_11-18-50     104   RH      C57 P41   F</span></span></code></pre>
<p>The second element, <strong>timeXtrial</strong>, is a list of
matrices, one per cell, with rows corresponding to time bins and columns
to trials. Each entry is a binary indicator of whether the cell fired in
that time bin during that trial. (No example shown here.)</p>
<p>The third element, <strong>cluster.key</strong>, is a data frame with
rows representing cells, columns giving information such as cell number,
genotype, and number of spikes. Here are the first few rows of the
<strong>cluster.key</strong> data frame:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                            recording.name cell cluster num.of.spikes num.of.responsive.trials hemi genotype age sex</span></span>
<span><span class="co">## 2025-04-03_11-18-50   2025-04-03_11-18-50    1     103         29627                      412   RH      C57 P41   F</span></span>
<span><span class="co">## 2025-04-03_11-18-50.1 2025-04-03_11-18-50    2      66         23091                      412   RH      C57 P41   F</span></span>
<span><span class="co">## 2025-04-03_11-18-50.2 2025-04-03_11-18-50    3      62         30997                      412   RH      C57 P41   F</span></span>
<span><span class="co">## 2025-04-03_11-18-50.3 2025-04-03_11-18-50    4     104         34072                      412   RH      C57 P41   F</span></span>
<span><span class="co">## 2025-04-03_11-18-50.4 2025-04-03_11-18-50    5      30          1263                      390   RH      C57 P41   F</span></span>
<span><span class="co">## 2025-04-03_11-18-50.5 2025-04-03_11-18-50    6      10          2406                      390   RH      C57 P41   F</span></span></code></pre>
<p>Important summary information can be pulled from the
<strong>cluster.key</strong> data frame. For example, how many cells
were included in the output?</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of cells included:"</span>, <span class="va">n_cells</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Number of cells included: 231</span></span></code></pre>
<p>The number of cells and summary statistics such as mean spike and
trial count per covariate combination can be pulled as well: (Age left
off for simplicity.)</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get all combinations of covariates</span></span>
<span><span class="va">covariate_combos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  genotype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">$</span><span class="va">genotype</span><span class="op">)</span>,</span>
<span>  hemi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">$</span><span class="va">hemi</span><span class="op">)</span>,</span>
<span>  sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">$</span><span class="va">sex</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">covariate_combos</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mean_spikes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">covariate_combos</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mean_trials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">covariate_combos</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop through combinations and print summary stats</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">cv</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">covariate_combos</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">combo</span> <span class="op">&lt;-</span> <span class="va">covariate_combos</span><span class="op">[</span><span class="va">cv</span>, <span class="op">]</span></span>
<span>  <span class="va">subset_key</span> <span class="op">&lt;-</span> <span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">[</span></span>
<span>    <span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">$</span><span class="va">genotype</span> <span class="op">==</span> <span class="va">combo</span><span class="op">$</span><span class="va">genotype</span> <span class="op">&amp;</span></span>
<span>    <span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">$</span><span class="va">hemi</span> <span class="op">==</span> <span class="va">combo</span><span class="op">$</span><span class="va">hemi</span> <span class="op">&amp;</span></span>
<span>    <span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">cluster.key</span><span class="op">$</span><span class="va">sex</span> <span class="op">==</span> <span class="va">combo</span><span class="op">$</span><span class="va">sex</span>, </span>
<span>  <span class="op">]</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">subset_key</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n_cells</span><span class="op">[</span><span class="va">cv</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">subset_key</span><span class="op">)</span></span>
<span>    <span class="va">mean_spikes</span><span class="op">[</span><span class="va">cv</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">subset_key</span><span class="op">$</span><span class="va">num.of.spikes</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">mean_trials</span><span class="op">[</span><span class="va">cv</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">subset_key</span><span class="op">$</span><span class="va">num.of.responsive.trials</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Print results </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">covariate_combos</span>, <span class="va">n_cells</span>, <span class="va">mean_spikes</span>, <span class="va">mean_trials</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     genotype hemi sex n_cells mean_spikes mean_trials</span></span>
<span><span class="co">## 1        C57   RH   F     167      2535.2       286.4</span></span>
<span><span class="co">## 2  Mecp2 HET   RH   F      29      1861.9       315.1</span></span>
<span><span class="co">## 3  Shank3 KO   RH   F      NA          NA          NA</span></span>
<span><span class="co">## 4        C57   LH   F       5       898.8       255.6</span></span>
<span><span class="co">## 5  Mecp2 HET   LH   F      NA          NA          NA</span></span>
<span><span class="co">## 6  Shank3 KO   LH   F      10       499.5       174.8</span></span>
<span><span class="co">## 7        C57   RH   M      NA          NA          NA</span></span>
<span><span class="co">## 8  Mecp2 HET   RH   M      NA          NA          NA</span></span>
<span><span class="co">## 9  Shank3 KO   RH   M       4     39055.5       456.0</span></span>
<span><span class="co">## 10       C57   LH   M       3      2283.3       203.7</span></span>
<span><span class="co">## 11 Mecp2 HET   LH   M      NA          NA          NA</span></span>
<span><span class="co">## 12 Shank3 KO   LH   M      13      1141.5       194.0</span></span></code></pre>
<h1>
Making neurons
</h1>
<p>With the kilosort4 data preprocessed into spike rasters, the next
step is to convert them into a special class of object from the neuron
package, <strong>neuron</strong>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">neurons.kilo4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load.rasters.as.neurons.html">load.rasters.as.neurons</a></span><span class="op">(</span><span class="va">spike.rasters.kilo4</span><span class="op">$</span><span class="va">spikes</span>, sample_rt <span class="op">=</span> <span class="fl">1e3</span><span class="op">)</span></span></code></pre></div>
<p>We want to load the spike rasters as <strong>neuron</strong>s because
<strong>neurons</strong>s come with built-in methods for estimating
autocorrelation parameters with dichotomized Gaussian simulations.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ... set number of sims to run per neuron</span></span>
<span><span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="co"># ... set number of trials to simulate per neuron</span></span>
<span><span class="va">n_trials</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="co"># ... run estimates on data</span></span>
<span><span class="va">autocor.ests.kilo4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate.autocorr.params.html">estimate.autocorr.params</a></span><span class="op">(</span></span>
<span>  neuron_list <span class="op">=</span> <span class="va">neurons.kilo4</span>,</span>
<span>  n_trials_per_sim <span class="op">=</span> <span class="va">n_trials</span>, </span>
<span>  n_sims_per_neurons <span class="op">=</span> <span class="va">n_sims</span>, </span>
<span>  bin_count_action <span class="op">=</span> <span class="st">"sum"</span>,</span>
<span>  A0 <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>  tau0 <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  ctol <span class="op">=</span> <span class="fl">1e-8</span>,</span>
<span>  max_evals <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Run analysis:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">autocorr_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/analyze.autocorr.html">analyze.autocorr</a></span><span class="op">(</span></span>
<span>  <span class="va">autocor.ests.kilo4</span>,</span>
<span>  covariate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hemi"</span>,<span class="st">"genotype"</span><span class="op">)</span>,</span>
<span>  n_bs <span class="op">=</span> <span class="fl">1e4</span>,</span>
<span>  bins_per_sec <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">autocorr_results</span>, use.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">autocorr_results</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">autocorr_results</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">title_size</span> <span class="op">&lt;-</span> <span class="fl">20</span> </span>
<span><span class="va">axis_size</span> <span class="op">&lt;-</span> <span class="fl">12</span> </span>
<span><span class="va">legend_size</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#scale_y_continuous(transform = "log1p") +</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Expected Time Constant"</span>, x <span class="op">=</span> <span class="st">"ms"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="va">title_size</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">axis_size</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">axis_size</span><span class="op">)</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">legend_size</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">legend_size</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_DG_analysis_of_kilosort_files/figure-html/stat_analysis-1.png" width="700"></p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Barkasi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
